<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cooking Metrics Studio</title>
  <style>
    body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f4f7f6; display: flex; justify-content: center; padding: 20px; }
    .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 100%; max-width: 500px; }
    .logo-container img { width: 100%; max-width: 350px; border-radius: 8px; }
    label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.85rem; color: #34495e; color: #34495e; /* è‰²ã‚’ä»–ã®ãƒ©ãƒ™ãƒ«ã¨çµ±ä¸€ */}
    input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
    #preview { width: 100%; max-height: 200px; object-fit: contain; margin-top: 10px; border-radius: 8px; display: none; border: 1px dashed #ccc; }
    .metric-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 10px; background: #fdfdfd; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
    .unit-label { font-size: 0.75rem; color: #95a5a6; margin-left: 4px; font-weight: normal; }
    .range-section { margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; }
    .range-container { margin-bottom: 15px; }
    .slider-wrapper { padding: 10px 0; display: flex; align-items: center; }
    input[type="range"] { width: 100%; cursor: pointer; height: 8px; accent-color: #3498db; }
    /* åˆæœŸçŠ¶æ…‹ã‚’è¦–è¦šçš„ã«è–„ãã™ã‚‹ */
    input[type="range"].initial-empty { opacity: 0.3; }
    .score-num { font-weight: bold; color: #3498db; margin-left: 10px; float: right; }
    .btn-group { margin-top: 25px; display: flex; flex-direction: column; gap: 12px; border-top: 2px dashed #eee; padding-top: 20px; }
    button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: transform 0.1s; }
    button:active { transform: scale(0.98); }
    #analyzeBtn { background-color: #3498db; color: white; }
    #loading { display: none; text-align: center; color: #3498db; margin: 10px 0; font-weight: bold; }
    .action-row { display: flex; gap: 12px; }
    .btn-save { flex: 3; background: linear-gradient(135deg, #2ecc71, #27ae60) !important; color: white; box-shadow: 0 4px 15px rgba(46,204,113,0.3); font-size: 1.1em !important; }
    .btn-clear { flex: 1; background: #f8f9fa !important; color: #636e72 !important; border: 1px solid #dfe6e9 !important; font-size: 0.9em !important; }

.description {
      font-size: 0.85rem;
      color: #7f8c8d;
      line-height: 1.5;
      margin: -10px 0 20px 0;
      text-align: center;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
    }
    .description em {
      font-style: normal;
      color: #3498db;
      font-weight: bold;
    }
/* ãƒªãƒ³ã‚¯ã®è¦ªè¦ç´ ã‚’ç›¸å¯¾ä½ç½®ã«è¨­å®š */
    .logo-container {
      position: relative; /* ã“ã‚Œã‚’è¿½åŠ  */
      text-align: center;
      margin-bottom: 25px;
    }

/* æ–°è¦è¿½åŠ : ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã¾ã¨ã‚ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ */
.manual-icon-group {
  position: absolute;
  top: 0; /* ãƒ­ã‚´ã‚³ãƒ³ãƒ†ãƒŠã®ä¸Šç«¯ */
  right: 0; /* ãƒ­ã‚´ã‚³ãƒ³ãƒ†ãƒŠã®å³ç«¯ */
  display: flex; /* ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ */
  gap: 8px; /* ã‚¢ã‚¤ã‚³ãƒ³é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
}

/* æ—¢å­˜ã® manual-link ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¿®æ­£ */
.manual-link {
  width: 24px;
  height: 24px;
  background: #fff;
  border: 1.5px solid #3498db;
  color: #3498db;
  border-radius: 50%;
  text-decoration: none;
  font-size: 14px;
  font-weight: bold;
  line-height: 24px; /* ã‚¢ã‚¤ã‚³ãƒ³ã®ç¸¦æ–¹å‘ä¸­å¤®æƒãˆ */
  text-align: center;
  transition: all 0.3s ease;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  /* position, top, right ã®æŒ‡å®šã¯ .manual-icon-group ã«ç§»å‹•ã™ã‚‹ãŸã‚å‰Šé™¤ */
}

.manual-link:hover {
  background: #3498db;
  color: #fff;
  transform: scale(1.1);
}

/* ãƒ©ãƒ™ãƒ«å†…ã‚’æ¨ªä¸¦ã³ã«æ•´ãˆã‚‹ */
    label {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 15px;
      font-weight: bold;
      font-size: 0.85rem;
      color: #3498db;
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®åœŸå° */
    .help-tip {
      position: relative;
      cursor: pointer;
      display: inline-flex;
    }

    /* ä¸¸ã„ï¼Ÿã‚¢ã‚¤ã‚³ãƒ³ */
    .help-icon-mini {
      width: 16px;
      height: 16px;
      border: 1px solid #3498db;
      color: #3498db;
      border-radius: 50%;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
    }

    /* ãƒãƒ«ãƒ¼ãƒ³æœ¬ä½“ï¼ˆçµ¶å¯¾ã«å‡ºã™ãŸã‚ã®èª¿æ•´ï¼‰ */
    .help-content {
      visibility: hidden;
      width: 240px;
      background-color: rgba(52, 73, 94, 0.95); /* å°‘ã—é€ã‘ãŸæ¿ƒã„è‰² */
      color: #fff;
      text-align: center;
      border-radius: 4px;
      padding: 6px;
      position: absolute;
      z-index: 100;
      bottom: 150%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 0.7rem;
      pointer-events: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);

      /* ã“ã‚Œã‚’è¿½åŠ ï¼ */
  white-space: pre-line; 
  text-align: left; /* æ”¹è¡Œã™ã‚‹ãªã‚‰å·¦å¯„ã›ãŒç¶ºéº—ã§ã™ */
    }

    .help-tip:hover .help-content {
      visibility: visible;
      opacity: 1;
    }

    /* å³å´ã®æ•°å€¤ã‚’å³ç«¯ã«è¿½ã„ã‚„ã‚‹ */
    .score-num {
      margin-left: auto; /* float:rightã®ä»£ã‚ã‚Šã«ã“ã‚Œã§å³ç«¯ã¸ */
      color: #3498db;
    }

.version-info {
      text-align: right;
      font-size: 10px;
      color: #95a5a6; /* è–„ã™ããªã„ã‚°ãƒ¬ãƒ¼ã«å¤‰æ›´ */
      margin-top: 15px;
      font-family: 'Courier New', Courier, monospace;
      letter-spacing: 0.5px;
      transition: color 0.3s; /* ãµã‚ã£ã¨å¤‰åŒ–ã•ã›ã‚‹ */
    }

    .version-info:hover {
      color: #3498db; /* ãƒã‚¦ã‚¹ã‚’ä¹—ã›ã‚‹ã¨é’ããªã£ã¦ã€Œç”Ÿãã¦ã‚‹ã€æ„ŸãŒå‡ºã‚‹ */
    }
/* ãƒ˜ãƒ«ãƒ—ã‚¢ã‚¤ã‚³ãƒ³ãŒãƒ©ãƒ™ãƒ«ã®ãƒ†ã‚­ã‚¹ãƒˆã¨ãã£ã¤ãã™ããªã„ã‚ˆã†ã« */
.help-tip {
  margin-left: 2px;
}

/* è§£æçµæœã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .analysis-container {
    margin-top: 15px;
    border: 1px solid #dfe6e9;
    border-radius: 8px;
    background-color: #fcfcfc;
overflow: visible !important; /* hiddenã‚’å¤–ã—ã¦ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¦‹ãˆã‚‹ã‚ˆã†ã« */
  }
  .analysis-container summary {
    padding: 10px 15px;
    background-color: #f1f2f6;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: bold;
    color: #2c3e50;
    outline: none;
    list-style: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .analysis-container summary::after { content: 'â–¼'; font-size: 0.7rem; color: #3498db; }
  .analysis-container[open] summary::after { content: 'â–²'; }
  .analysis-content {
    padding: 12px;
    font-size: 0.8rem;
    color: #636e72;
    line-height: 1.6;
    white-space: pre-wrap;
    border-top: 1px solid #eee;
  }
  #analysis_text { font-family: 'Courier New', Courier, monospace; color: #2980b9; }

/* è©³ç´°å†…è¨³ï¼šé–“å»¶ã³è§£æ¶ˆç‰ˆ */
.maint-details-content {
  /* ä¸Šä¸‹ã®ä½™ç™½ã‚’æ¥µé™ã¾ã§å‰Šã‚‹ */
  padding: 2px 10px !important; 
  background: #fdfdfd;
}
/* --- ä¿å®ˆæ€§è©³ç´°ï¼šå¼·åˆ¶ã‚¿ã‚¤ãƒˆåŒ– --- */
.maint-details-content {
  padding: 5px 8px !important;
  background: #fdfdfd;
}

/* é …ç›®1è¡Œã®é«˜ã•ã‚’ç„¡ç†ã‚„ã‚Šå›ºå®šã™ã‚‹ */
.sub-range-group {
  display: flex !important;
  align-items: center !important;
  height: 28px !important; /* ã“ã“ã§é«˜ã•ã‚’å¼·åˆ¶ */
  margin: 0 !important;
  padding: 0 !important;
  border-bottom: 1px solid #f0f0f0;
  gap: 8px;
}

/* ãƒ©ãƒ™ãƒ«ã®ä½™ç™½ã¨ã‚µã‚¤ã‚ºã‚’å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ */
.sub-label {
display: flex !important;
  align-items: center;
  gap: 3px;
  flex: 0 0 90px !important; /* å¹…ã‚’å°‘ã—åºƒã’ã¦ã‚¢ã‚¤ã‚³ãƒ³åˆ†ã‚’ç¢ºä¿ */
  font-size: 0.65rem !important; /* å°‘ã—æ–‡å­—ã‚’å°ã•ãã—ã¦åã¾ã‚Šã‚’è‰¯ãã™ã‚‹ */
}

.sub-slider-container {
  flex: 1 !important;
  display: flex !important;
  align-items: center !important;
  height: 28px !important;
}

/* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æœ¬ä½“ã®åšã¿ã‚’æ®ºã™ */
.sub-slider-container input[type="range"] {
  flex: 1 !important;
  height: 4px !important; /* æ£’ã®å¤ªã• */
  margin: 0 !important;
  padding: 0 !important;
  background: #eee !important;
  appearance: none !important;
  -webkit-appearance: none !important;
}

/* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã€Œã¤ã¾ã¿ã€ã‚’å°ã•ãã™ã‚‹ */
.sub-slider-container input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none !important;
  width: 12px !important;
  height: 12px !important;
  background: #3498db !important;
  border-radius: 50% !important;
  cursor: pointer;
}

.sub-score {
  flex: 0 0 35px !important;
  font-family: monospace !important;
  font-size: 0.75rem !important;
  margin: 0 !important;
  text-align: right;
  color: #3498db;
}

/* detailsã®ä¸­ã®æ”¹è¡Œè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã€HTMLã®éš™é–“ã‚’æ¶ˆã™ */
.analysis-container .analysis-content {
  white-space: normal !important;
}

/* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®è¡Œï¼ˆdivï¼‰ã‚’æ¨ªä¸¦ã³ã«ã—ã€ä¸Šä¸‹ã®éš™é–“ã‚’ã‚¼ãƒ­ã«ã™ã‚‹ */
.analysis-container .analysis-content div {
  display: flex !important;
  align-items: center;
  margin: 0 !important;
  padding: 2px 0 !important; /* 1è¡Œã®éš™é–“ã‚’æœ€å°é™ã« */
}
  </style>
  <?!= HtmlService.createHtmlOutputFromFile('titleImg_Base64').getContent(); ?>
<?!= HtmlService.createHtmlOutputFromFile('Img_Win').getContent(); ?>
<?!= HtmlService.createHtmlOutputFromFile('Img_Lose').getContent(); ?>  
</head>
<body>

<div class="container">
  <div class="logo-container">
<div class="manual-icon-group">
    <a href="https://github.com/Human-Life-Metrics-Studio/CookingMetricsFront/blob/main/README.md" target="_blank" class="manual-link" title="ãƒ˜ãƒ«ãƒ—ã‚’è¦‹ã‚‹">?</a>
    <a href="https://github.com/Human-Life-Metrics-Studio/CookingMetricsHandbook/blob/main/docs/handbook.md" target="_blank" class="manual-link" title="æœ€åˆã¯ãƒãƒ³ãƒ‰ãƒ–ãƒƒã‚¯ã‚’è¦‹ã¦ã­">ğŸ“–</a>
  </div>    
    <img id="headerImage" alt="Cooking Metrics Studio">
    <script>
    // èª­ã¿è¾¼ã¾ã‚ŒãŸå®šæ•°ã‚’srcã«å…¥ã‚Œã‚‹ã ã‘
    document.getElementById('headerImage').src = HEADER_IMG_DATA;
  </script>
  </div>
  
  <div class="description">
    ãƒ¡ãƒ‹ãƒ¥ãƒ¼åã‚„æ•°å€¤ã‚’è‡ªåˆ†ã§å…¥åŠ›ã—ã¦ã‚‚ã€<em>ã€ŒAIã§åˆ†æã€</em>ã«ãŠä»»ã›ã—ã¦ã‚‚OKã§ã™ã€‚<br>
    AIã®æ¨æ¸¬çµæœã¯å¾Œã‹ã‚‰è‡ªç”±ã«æ›¸ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚
  </div>

  <label>ğŸ“¸ æ–™ç†å†™çœŸ</label>
  <input type="file" id="photo" accept="image/*" onchange="previewImage(this)">
  <img id="preview">

  <label>ğŸ½ ãƒ¡ãƒ‹ãƒ¥ãƒ¼å</label>
  <input type="text" id="menu" placeholder="ä¾‹ï¼šè‚‰ã˜ã‚ƒãŒã€ã‚ªãƒ ãƒ©ã‚¤ã‚¹">

  <label>ğŸ•’ é£Ÿäº‹ã®åŒºåˆ†</label>
  <select id="meal_type">
    <option value="æœé£Ÿ">â˜€ï¸ æœé£Ÿ</option>
    <option value="æ˜¼é£Ÿ" selected>ğŸ•› æ˜¼é£Ÿ</option>
    <option value="å¤•é£Ÿ">ğŸŒ™ å¤•é£Ÿ</option>
  </select>

  <label>ğŸ¯ é‡è¦–ã™ã‚‹æŒ‡æ¨™</label>
  <select id="weightedAxis">
    <option value="satisfaction_score">ğŸ˜Š æº€è¶³åº¦ (é€šå¸¸)</option>
    <option value="cost_score">ğŸ’¸ è²»ç”¨ (ç¯€ç´„)</option>
    <option value="time_score">â± æ™‚é–“ (ã‚¿ã‚¤ãƒ‘)</option>
    <option value="nutrition_score">ğŸ¥— æ „é¤Š (å¥åº·)</option>
    <option value="maint_score">ğŸ”§ ä¿å®ˆæ€§ (æ¥½ã•)</option>
  </select>
<label>ğŸ  é£Ÿäº‹ã®ã‚¹ã‚¿ã‚¤ãƒ«</label>
<select id="cooking_style">
  <option value="è‡ªç‚Š" selected>ğŸ³ è‡ªç‚Šä¸­å¿ƒ</option>
  <option value="å¤–é£Ÿãƒ»ä¸­é£Ÿ">è‡ªç‚Šä»¥å¤–ä¸­å¿ƒ</option>
</select>
  <div class="metric-grid">
<div>
    <label>
      ğŸ’¸ è²»ç”¨ <span class="unit-label">(å††)</span>
      <span class="help-tip">
        <span class="help-icon-mini">?</span>
        <span class="help-content">100å††å˜ä½ãã‚‰ã„ã§OK
        åœ¨åº«ã®ææ–™ã®é‡‘é¡ã‚‚å«ã‚€ï¼ˆè²·ã£ã¦ãŠã„ãŸ200å††ã®ã‚«ãƒƒãƒ—éººã®è²»ç”¨ã¯200å††ï¼‰
      </span>
    </label>
    <input type="number" id="cost_raw" value="300">
  </div>
  <div>
    <label>
      â± æ™‚é–“ <span class="unit-label">(åˆ†)</span>
      <span class="help-tip">
        <span class="help-icon-mini">?</span>
        <span class="help-content">æº–å‚™ï¼‹èª¿ç†æ™‚é–“
          å¾…ã¡æ™‚é–“ã€æ‰‹ã‚’æ”¾ã—ã¦ã„ã‚‹æ™‚é–“ï¼ˆã‚¿ã‚¤ãƒãƒ¼æ”¾ç½®ãªã©ï¼‰ã€é£Ÿã¹ã‚‹æ™‚é–“ã¯å«ã‚ãªã„
        </span>
      </span>
    </label>
    <input type="number" id="time_raw" value="15">
  </div>


    
<div style="grid-column: span 2;">
  <label>
    ğŸ¥— æ „é¤Š <span class="unit-label">(1-7ç¨®)</span>
    <span class="help-tip">
      <span class="help-icon-mini">?</span>
      <span class="help-content">
        7å¤§æ „é¤Šç´ ã®æ•°ã§æ¡ç‚¹ã™ã‚‹ã€‚
        
        1. ç‚­æ°´åŒ–ç‰©	ç™½ç±³ã€ãƒ‘ãƒ³ã€éººé¡ã€ã‚¤ãƒ¢é¡ã€ç ‚ç³–
        2. è„‚è³ª	ã‚µãƒ©ãƒ€æ²¹ã€ãƒã‚¿ãƒ¼ã€é’é­šã®è„‚ã€ãƒŠãƒƒãƒ„é¡
        3. ãŸã‚“ã±ãè³ª	è‚‰ã€é­šã€åµã€å¤§è±†è£½å“ã€ä¹³è£½å“
        4. ãƒ“ã‚¿ãƒŸãƒ³	é‡èœã€æœç‰©ã€ãƒ¬ãƒãƒ¼ã€ã‚­ãƒã‚³é¡
        5. ãƒŸãƒãƒ©ãƒ«	ç‰›ä¹³ã€å°é­šã€æµ·è—»ã€è²é¡ã€å¡©
        6. é£Ÿç‰©ç¹Šç¶­	ç„ç±³ã€ã‚´ãƒœã‚¦ã€æµ·è—»ã€ã“ã‚“ã«ã‚ƒãã€è±†é¡
        7. ãƒ•ã‚¡ã‚¤ãƒˆã‚±ãƒŸã‚«ãƒ«	è‰²ãŒæ¿ƒã„é‡èœã‚„ã€è–¬å‘³ã€ãŠèŒ¶ãŒã‚ã‚Œã°OK
        -----
        7ç¨®ï¼š+0.30
        6ç¨®ï¼š+0.15
        5ç¨®ï¼š 0.00
        4ç¨®ï¼š-0.20
        3ç¨®ä»¥ä¸‹ï¼š-0.40
        -----
        æœ€å¾Œã«ã€å…¨ä½“çš„ã«å¤–é£Ÿãƒ»ä¸­é£Ÿä¸­å¿ƒãªã‚‰-0.1ã™ã‚‹
      </span>
    </span>
    </label>
  <input type="number" id="nutrition_raw" min="1" max="7" value="5">
</div>
  </div>

  <div class="range-section">

<div class="range-container">
      <label>
        ğŸ˜Š æº€è¶³åº¦
        <span class="help-tip">
          <span class="help-icon-mini">?</span>
          <span class="help-content">+0.30	ç¥
+0.20	ã†ã¾ã‚ã‚ã‚ã‚ã‚ã‚
+0.10	ã‹ãªã‚ŠãŠã„ã—ã„
0.00	ãµã¤ã†ã«ãŠã„ã—ã„
-0.10	å¾®å¦™
-0.20	æ‚ªã„
-0.30	åœ°é›·</span>
        </span>
        <span id="satisfaction_val" class="score-num">æœªå…¥åŠ›</span>
      </label>
      <div class="slider-wrapper">
        <input type="range" id="satisfaction_raw" min="-0.3" max="0.3" step="0.05" class="initial-empty" oninput="updateVal('satisfaction')">
      </div>
    </div>

<div class="range-container">
  <label>
    ğŸ”§ ä¿å®ˆæ€§
    <span class="help-tip">
      <span class="help-icon-mini">?</span>
      <span class="help-content">è©³ç´°ã¯ä¸‹ã‚’å±•é–‹ã—ã¦èª¿æ•´</span>
    </span>
    <span id="maint_val" class="score-num">æœªå…¥åŠ›</span>
  </label>
  <div class="slider-wrapper">
    <input type="range" id="maint_raw" min="-0.7" max="0.3" step="0.05" class="initial-empty" oninput="updateVal('maint')">
  </div>

  <details class="analysis-container" style="margin-top: 5px; border-color: #eee;">
    <summary style="font-size: 0.7rem; padding: 4px 10px; background: #f1f2f6;">å†…è¨³ã‚’èª¿æ•´ã™ã‚‹</summary>
    <div class="analysis-content maint-details-content">
      
<div class="sub-range-group">
  <label class="sub-label">
    ğŸ§¼ æ´—ç‰©
    <span class="help-tip">
      <span class="help-icon-mini">?</span>
      <span class="help-content">é‹ãƒ»ãƒ•ãƒ©ã‚¤ãƒ‘ãƒ³ã®æ•°ã‚„ã€æ²¹æ±šã‚Œã®ã²ã©ã•ã§åˆ¤å®šã€‚
        â€»ç‰‡ã¥ã‘æ™‚é–“ã‚’0.1=5åˆ†ã§ãªã‚“ã¨ãªãç®—å‡ºã—ã¦æ¸›ç‚¹ã™ã‚‹
        0.0: ã»ã¼ãªã—ï¼ˆã‚³ãƒƒãƒ—ç®¸ãƒ¯ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç¨‹åº¦ï¼‰
        -0.5: æœ€æ‚ªï¼ˆæšã’ç‰©ã€èª¿ç†å™¨å…·å¤šæ•°ï¼‰ 25åˆ†ãã‚‰ã„ã‹ã‹ã‚‹</span>
    </span>
  </label>
  <div class="sub-slider-container">
    <input type="range" id="maint_wash" min="-0.5" max="0.0" step="0.05" value="0" oninput="calculateMaint()">
    <span class="sub-score" id="maint_wash_val">0.00</span>
  </div>
</div>

<div class="sub-range-group">
  <label class="sub-label">
    ğŸ—‘ï¸ ã‚´ãƒŸ
    <span class="help-tip">
      <span class="help-icon-mini">?</span>
      <span class="help-content">ç”Ÿã‚´ãƒŸã‚„ãƒ—ãƒ©å®¹å™¨ã®é‡ã€‚
        0.0: ã»ã¼ãªã—
        -0.1: æ™®é€šï¼ˆãƒ‘ãƒƒã‚¯1ã¤ç­‰ï¼‰
        -0.2: å¤§é‡ï¼ˆãƒˆãƒ¬ã‚¤å¤šæ•°ã€ç”Ÿã‚´ãƒŸå¤šï¼‰</span>
    </span>
  </label>
  <div class="sub-slider-container">
    <input type="range" id="maint_waste" min="-0.2" max="0.0" step="0.05" value="0" oninput="calculateMaint()">
    <span class="sub-score" id="maint_waste_val">0.00</span>
  </div>
</div>

<div class="sub-range-group">
  <label class="sub-label">
    ğŸ§Š åœ¨åº«
    <span class="help-tip">
      <span class="help-icon-mini">?</span>
      <span class="help-content">å†·è”µã€å†·å‡ã®å¤šã•ã€‚
        0.0: ã»ã¼ãªã—
        -0.1:ãµã¤ã†
        -0.2: ã»ã¼å†·è”µå†·å‡</span>
    </span>
  </label>
  <div class="sub-slider-container">
    <input type="range" id="maint_stock" min="-0.2" max="0.0" step="0.05" value="0" oninput="calculateMaint()">
    <span class="sub-score" id="maint_stock_val">0.00</span>
  </div>
</div>

<div class="sub-range-group">
  <label class="sub-label">
    ğŸš¶ å¤–å‡º
    <span class="help-tip">
      <span class="help-icon-mini">?</span>
      <span class="help-content">ãã®é£Ÿäº‹ã®ãŸã‚ã®å¤–å‡ºæœ‰ç„¡
        0.0: è‡ªå®…ï¼ˆè‡ªç‚Šãƒ»ãƒ‡ãƒªãƒãƒªãƒ¼ï¼‰
        -0.1: å¤–é£Ÿãƒ»ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆè²·ã„å‡ºã—</span>
    </span>
  </label>
  <div class="sub-slider-container">
    <input type="range" id="maint_out" min="-0.1" max="0.0" step="0.1" value="0" oninput="calculateMaint()">
    <span class="sub-score" id="maint_out_val">0.00</span>
  </div>
</div>

    </div>
  </details>
</div>

    <label>ğŸ¥• ä¸»ãªé£Ÿæ</label>
    <input type="text" id="ingredients">

    <label>ğŸ“ ã‚³ãƒ¡ãƒ³ãƒˆ</label>
    <textarea id="comment" rows="3"></textarea>

    <details class="analysis-container" id="analysis_wrapper">
    <summary>ğŸ“Š AIã®è¨ˆç®—æ ¹æ‹ ã‚’ç¢ºèª</summary>
    <div class="analysis-content">
      <div id="analysis_text">ã“ã“ã«è§£æã®è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
      <input type="hidden" id="analysis_val">
    </div>
  </details>
  </div>

<div class="btn-group">
  <div style="display: flex; gap: 10px; margin-bottom: 10px;">
    <button id="analyzeBtn" onclick="runAnalysis()" style="flex: 1; margin: 0;">1. AIã§åˆ†æ</button>
    
<div id="iconContainer" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; box-sizing: border-box; flex-shrink: 0;">
    <img id="resultIcon" src="" style="max-width: 100%; max-height: 100%; display: none; object-fit: contain;">
  </div>
  </div>

  <div id="loading" style="display:none; text-align:center; font-size:0.9rem; color:#666; margin: -5px 0 5px 0;">ğŸ“Š AIãŒè¨ˆç®—ä¸­...</div>
  
  <div style="display: flex; gap: 10px;">
    <button id="saveBtn" onclick="runSave()" class="btn-save" style="flex: 1; margin: 0;">2. ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
    
    <div style="width: 50px; flex-shrink: 0;">
      <button type="button" onclick="clearForm()" class="btn-clear" style="width: 100%; height: 50px; margin: 0; padding: 0;">ã‚¯ãƒªã‚¢</button>
    </div>
  </div>
</div>

  <div id="successArea" style="display:none; margin-top:15px; padding:10px; border:2px solid #2ecc71; border-radius:8px; background:#fafffd; text-align:center;">
    <span style="color:#27ae60; font-weight:bold; display:block; margin-bottom:8px;">âœ… ä¿å­˜ã—ã¾ã—ãŸï¼</span>
    <a id="dashboardLink" href="#" target="_blank" style="color:#3498db; font-weight:bold; font-size:1.1rem;">
      ğŸ“Š ã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã™ã‚‹
    </a>
  </div>



<div class="version-info">
  ãƒãƒ¼ã‚¸ãƒ§ãƒ³: <?= deployDate ?>
</div>
</div>
<script>
  function previewImage(input) {
    const preview = document.getElementById('preview');
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = e => { preview.src = e.target.result; preview.style.display = 'block'; };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function roundToStep(value, step) {
    if (value === undefined || value === null) return "";
    return (Math.round(value / step) * step).toFixed(2);
  }

  function updateVal(type) {
    const el = document.getElementById(type + '_raw');
    const display = document.getElementById(type + '_val');
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‹•ã‹ã—ãŸã‚‰ã‚¯ãƒ©ã‚¹ã‚’æ¶ˆã™
    el.classList.remove('initial-empty');
    display.innerText = parseFloat(el.value).toFixed(2);
    // ã“ã‚Œã‚’è¿½åŠ ï¼
  updateCommentScore();
  }

function clearForm() {
  // confirm("å…¥åŠ›ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ") ã‚’å‰Šé™¤ã—ã¦å³å®Ÿè¡Œ
  ['menu', 'photo', 'cost_raw', 'time_raw', 'nutrition_raw', 'ingredients', 'comment'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });

  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ç‰¹æ®Šãƒªã‚»ãƒƒãƒˆ
  ['satisfaction', 'maint'].forEach(type => {
    const el = document.getElementById(type + '_raw');
    const display = document.getElementById(type + '_val');
    if (el) el.classList.add('initial-empty');
    if (display) display.innerText = "æœªå…¥åŠ›";
  });

  // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨æˆåŠŸã‚¨ãƒªã‚¢ã‚’éš ã™
  document.getElementById('preview').style.display = 'none';
  document.getElementById('successArea').style.display = 'none';

  // ã€è¿½åŠ ã€‘ã‚¿ã‚³ï¼ˆåˆ¤å®šã‚¢ã‚¤ã‚³ãƒ³ï¼‰ã‚‚æ¶ˆã™
  const iconEl = document.getElementById('resultIcon');
  if (iconEl) {
    iconEl.src = "";
    iconEl.style.display = 'none';
  }
}

function runAnalysis() {
  const menu = document.getElementById('menu').value;
  const ingredients = document.getElementById('ingredients').value;
  const style = document.getElementById('cooking_style').value; 
  
  const fileInput = document.getElementById('photo');
  const loading = document.getElementById('loading');
  const btn = document.getElementById('analyzeBtn');

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã¨ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
  loading.style.display = 'block';
  btn.disabled = true;

  // å…±é€šã®ã‚¨ãƒ©ãƒ¼å‡¦ç†é–¢æ•°
  const errorHandler = (err) => {
    loading.style.display = 'none';
    btn.disabled = false;
    console.error(err);
    alert('AIåˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è©¦ã™ã‹ã€æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n(ã‚¨ãƒ©ãƒ¼å†…å®¹: ' + err.message + ')');
  };

  if (fileInput.files.length > 0) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const base64Data = e.target.result.split(',')[1];
      google.script.run
        .withSuccessHandler(res => { 
          fillFields(res); 
          btn.disabled = false; 
          loading.style.display = 'none'; 
        })
        .withFailureHandler(errorHandler) // â˜…è¿½åŠ ï¼šGASå´ã®ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
        .analyzeCookingWithImage(base64Data, menu, ingredients, style); 
    };
    reader.onerror = errorHandler; // â˜…è¿½åŠ ï¼šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼
    reader.readAsDataURL(fileInput.files[0]);
  } else {
    if (!menu) { 
      alert('å†™çœŸã‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼åãŒå¿…è¦ã§ã™'); 
      loading.style.display = 'none'; 
      btn.disabled = false; 
      return; 
    }
    google.script.run
      .withSuccessHandler(res => { 
        fillFields(res); 
        btn.disabled = false; 
        loading.style.display = 'none'; 
      })
      .withFailureHandler(errorHandler) // â˜…è¿½åŠ ï¼šGASå´ã®ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
      .analyzeCooking({ menu: menu, ingredients: ingredients, cooking_style: style }); 
  }
}

/**
 * AIã®è§£æçµæœã‚’ç”»é¢ã®å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åæ˜ ã™ã‚‹
 */
function fillFields(data) {
  if (!data) return;

  // 1. åŸºæœ¬é …ç›®ã®åæ˜ 
  if (data.menu) document.getElementById('menu').value = data.menu;
  if (data.ingredients) document.getElementById('ingredients').value = data.ingredients;
  if (data.cost_val) document.getElementById('cost_raw').value = data.cost_val;
// time_val ãŒ 0 ã®æ™‚ã‚‚ä»£å…¥ã•ã‚Œã‚‹ã‚ˆã†ã«åˆ¤å®šã‚’å³å¯†ã«ã™ã‚‹
if (data.time_val !== undefined && data.time_val !== null) {
  document.getElementById('time_raw').value = data.time_val;
}
  if (data.nutrition_val) document.getElementById('nutrition_raw').value = data.nutrition_val;
  
  // 2. æº€è¶³åº¦
  if (data.satisfaction_score !== undefined) {
    const satSlider = document.getElementById('satisfaction_raw');
    if (satSlider) {
      satSlider.value = data.satisfaction_score;
      satSlider.classList.remove('initial-empty');
      document.getElementById('satisfaction_val').innerText = data.satisfaction_score.toFixed(2);
    }
  }

  // 3. ä¿å®ˆæ€§ã®è©³ç´°
  if (data.wash !== undefined)  document.getElementById('maint_wash').value = data.wash;
  if (data.waste !== undefined) document.getElementById('maint_waste').value = data.waste;
  if (data.stock !== undefined) document.getElementById('maint_stock').value = data.stock;
  if (data.out !== undefined)   document.getElementById('maint_out').value = data.out;

  // 4. ã‚¢ãƒ—ãƒªå´ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚„ä¿å®ˆæ€§åˆè¨ˆå€¤ï¼‰ã‚’å…ˆã«æ›´æ–°
  if (typeof calculateMaint === 'function') {
    calculateMaint();
  }

  // 5. åˆ†ææ ¹æ‹ ã¨ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆAIã®ç”Ÿã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã¾ãšå…¥ã‚Œã‚‹ï¼‰
  if (data.analysis) document.getElementById('analysis_text').innerText = data.analysis;
  if (data.comment) {
    document.getElementById('comment').value = data.comment;
  }

  // â˜…é‡è¦ï¼šã“ã“ã§å…±é€šã®è¨ˆç®—é–¢æ•°ã‚’å‘¼ã³å‡ºã™
  // ã“ã‚Œã«ã‚ˆã‚Šã€Œè‡ªç‚Šä»¥å¤–ãªã‚‰æ „é¤Š-0.1ã€ãŒé©ç”¨ã•ã‚Œã€1è¡Œç›®ã®ã€å‹ã¡é£¯ã€‘ãƒ©ã‚¤ãƒ³ã‚‚æ­£ã—ãç”Ÿæˆã•ã‚Œã¾ã™
  if (typeof updateCommentScore === 'function') {
    updateCommentScore();
  }

  document.getElementById('loading').style.display = 'none';
}
function runSave() {
    const saveBtn = document.getElementById('saveBtn');
    const menuName = document.getElementById('menu').value;
    if (!menuName) { alert('ãƒ¡ãƒ‹ãƒ¥ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

    saveBtn.disabled = true;
    saveBtn.innerText = "ä¿å­˜ä¸­...";

    // 0. ã‚¹ã‚¿ã‚¤ãƒ«ã®å–å¾—
    const cookingStyle = document.getElementById('cooking_style').value;

    // 1. å„ã‚¹ã‚³ã‚¢ã®ç®—å‡º
    const rawCost = parseFloat(document.getElementById('cost_raw').value || 0);
    const c_s = Math.max(-0.5, Math.min(0.3, 0.0 - ((rawCost - 600) / 100 * 0.05)));

    const rawTime = parseFloat(document.getElementById('time_raw').value || 0);
    const t_s = Math.max(-0.5, Math.min(0.3, 0.0 - ((rawTime - 15) * 0.02)));
    
    // --- æ „é¤Šã‚¹ã‚³ã‚¢ã®ç®—å‡ºã¨ãƒšãƒŠãƒ«ãƒ†ã‚£é©ç”¨ ---
    const n_v = parseFloat(document.getElementById('nutrition_raw').value || 0);
    let n_s = n_v >= 7 ? 0.3 : n_v >= 6 ? 0.15 : n_v >= 5 ? 0.0 : n_v >= 4 ? -0.2 : -0.4;
    
    // â˜… è‡ªç‚Šä»¥å¤–ï¼ˆå¤–é£Ÿãƒ»ä¸­é£Ÿï¼‰ãªã‚‰æ „é¤Šã‚¹ã‚³ã‚¢ã‚’ä¸€å¾‹ -0.1
    if (cookingStyle !== "è‡ªç‚Š") {
        n_s -= 0.1;
    }
    
    const satEl = document.getElementById('satisfaction_raw');
    const maintEl = document.getElementById('maint_raw');
    const s_s = satEl.classList.contains('initial-empty') ? 0 : parseFloat(satEl.value);
    const m_s = maintEl.classList.contains('initial-empty') ? 0 : parseFloat(maintEl.value);

    // 2. ã‚°ãƒ­ãƒ¼ãƒãƒ«CWAR (æ›´æ–°å¾Œã® n_s ã‚’ä½¿ç”¨)
    const global_cwar = c_s + t_s + n_s + s_s + m_s;

    // é‡è¦–æŒ‡æ¨™ãƒœãƒ¼ãƒŠã‚¹ã®ç®—å‡º
    const weightedKey = document.getElementById('weightedAxis').value;
    let bonus = 0;
    if (weightedKey === "cost_score") bonus = c_s;
    else if (weightedKey === "time_score") bonus = t_s;
    else if (weightedKey === "nutrition_score") bonus = n_s; // ã“ã“ã‚‚ä¿®æ­£å¾Œã® n_s ãŒåæ˜ ã•ã‚Œã‚‹
    else if (weightedKey === "satisfaction_score") bonus = s_s;
    else if (weightedKey === "maint_score") bonus = m_s;

    const local_cwar = global_cwar + bonus;

    // 3. é€ä¿¡ç”¨ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
    const finalData = {
      menu: menuName,
      meal_type: document.getElementById('meal_type').value,
      ingredients: document.getElementById('ingredients').value,
      cost_raw: rawCost,
      time_raw: rawTime,
      cost_score: c_s,
      time_score: t_s,
      nutrition_score: n_s, // â˜… ãƒšãƒŠãƒ«ãƒ†ã‚£é©ç”¨æ¸ˆã¿ã®ã‚¹ã‚³ã‚¢
      satisfaction_score: s_s,
      maint_score: m_s,
      global_cwar: global_cwar, // â˜… åˆç®—å€¤ã‚‚è‡ªå‹•çš„ã«ãƒšãƒŠãƒ«ãƒ†ã‚£è¾¼ã¿ã«ãªã‚‹
      local_cwar: local_cwar,   // â˜… åŒä¸Š
      weightedAxisKey: weightedKey, 
      weightedAxisLabel: document.getElementById('weightedAxis').options[document.getElementById('weightedAxis').selectedIndex].text,
      comment: document.getElementById('comment').value
    };

    const isMobile = window.innerWidth <= 768;
    google.script.run
      .withSuccessHandler(url => {
        saveBtn.disabled = false;
        saveBtn.innerText = "2. ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜";
        document.getElementById('dashboardLink').href = url;
        document.getElementById('successArea').style.display = 'block';
        document.getElementById('successArea').scrollIntoView({ behavior: 'smooth' });
      })
      .withFailureHandler(err => {
        alert("ä¿å­˜å¤±æ•—: " + err.message);
        saveBtn.disabled = false;
        saveBtn.innerText = "2. ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜";
      })
      .saveDataAndGetDashboardUrl(finalData, isMobile);
}

</script>
<script>
/**
 * ä¿å®ˆæ€§ã®å†…è¨³ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‹ã‚‰åˆè¨ˆå€¤ã‚’ç®—å‡ºã—ã€ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¸åæ˜ ã™ã‚‹
 */
function calculateMaint() {
  // 1. å„è©³ç´°ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®è¦ç´ ã‚’å–å¾—
  const elWash   = document.getElementById('maint_wash');
  const elWaste  = document.getElementById('maint_waste');
  const elStock  = document.getElementById('maint_stock');
  const elOut    = document.getElementById('maint_out');
  
  // 2. æ•°å€¤ã‚’å–å¾—ï¼ˆå–å¾—å¤±æ•—æ™‚ã¯0ã¨ã—ã¦æ‰±ã†ï¼‰
  const wash  = parseFloat(elWash.value) || 0;
  const waste = parseFloat(elWaste.value) || 0;
  const stock = parseFloat(elStock.value) || 0;
  const out   = parseFloat(elOut.value) || 0;

  // 3. å„é …ç›®ã®å³å´ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ•°å€¤ï¼ˆspanï¼‰ã‚’æ›´æ–°
  document.getElementById('maint_wash_val').innerText  = wash.toFixed(2);
  document.getElementById('maint_waste_val').innerText = waste.toFixed(2);
  document.getElementById('maint_stock_val').innerText = stock.toFixed(2);
  document.getElementById('maint_out_val').innerText   = out.toFixed(2);

  // 4. åˆè¨ˆã‚¹ã‚³ã‚¢ã®è¨ˆç®—ï¼ˆãƒ™ãƒ¼ã‚¹ 0.3 + å„æ¸›ç‚¹é …ç›®ï¼‰
  const baseScore = 0.3;
  const totalScore = baseScore + wash + waste + stock + out;
  
  // 5. ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆä¿å®ˆæ€§ï¼‰ã¸ã®åæ˜ 
  const mainSlider = document.getElementById('maint_raw');
  const mainDisplay = document.getElementById('maint_val');
  
  if (mainSlider && mainDisplay) {
    mainSlider.value = totalScore.toFixed(2);
    mainSlider.classList.remove('initial-empty'); // ç°è‰²çŠ¶æ…‹ã‚’è§£é™¤
    mainDisplay.innerText = totalScore.toFixed(2);
  }
  // --- è¿½åŠ ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ ---
  updateCommentScore();
}

/**
 * ã‚¹ã‚³ã‚¢è¨ˆç®—ã¨ã‚³ãƒ¡ãƒ³ãƒˆæ›´æ–°
 * è‡ªç‚Šä»¥å¤–ï¼ˆå¤–é£Ÿãƒ»ä¸­é£Ÿï¼‰ã®å ´åˆã¯ã€æ „é¤Šã‚¹ã‚³ã‚¢(n_s)ã‚’ä¸€å¾‹ -0.1 ã™ã‚‹
 */
function updateCommentScore() {
  const commentEl = document.getElementById('comment');
  const iconEl = document.getElementById('resultIcon');
  const cookingStyleEl = document.getElementById('cooking_style');
  if (!commentEl || !cookingStyleEl) return;

  const cookingStyle = cookingStyleEl.value;

  // --- 1. åŸºæœ¬ã‚¹ã‚³ã‚¢ã®ç®—å‡º ---
  
  // è²»ç”¨ã‚¹ã‚³ã‚¢: 600å††åŸºæº–(0.0)ã€100å††ã”ã¨ã«-0.05
  const c_v = parseFloat(document.getElementById('cost_raw').value) || 0;
  const c_s = Math.max(-0.5, Math.min(0.3, 0.0 - ((c_v - 600) / 100 * 0.05)));
  
  // æ™‚é–“ã‚¹ã‚³ã‚¢: 15åˆ†åŸºæº–(0.0)ã€1åˆ†ã”ã¨ã«-0.02
  const t_v = parseFloat(document.getElementById('time_raw').value) || 0;
  const t_s = Math.max(-0.5, Math.min(0.3, 0.0 - ((t_v - 15) * 0.02)));
  
  // æ „é¤Šã‚¹ã‚³ã‚¢: æ®µéšè©•ä¾¡
  const n_v = parseFloat(document.getElementById('nutrition_raw').value) || 0;
  let n_s = n_v >= 7 ? 0.3 : n_v >= 6 ? 0.15 : n_v >= 5 ? 0.0 : n_v >= 4 ? -0.2 : -0.4;
  
  // â˜… è‡ªç‚Šä»¥å¤–ãªã‚‰æ „é¤Šé¢ã‚’ä¸€å¾‹ãƒã‚¤ãƒŠã‚¹è£œæ­£
  if (cookingStyle !== "è‡ªç‚Š") {
    n_s -= 0.1;
  }
  
  // æº€è¶³åº¦ãƒ»ä¿å®ˆæ€§
  const s_s = !document.getElementById('satisfaction_raw').classList.contains('initial-empty') 
              ? parseFloat(document.getElementById('satisfaction_raw').value) : 0;
  const m_s = !document.getElementById('maint_raw').classList.contains('initial-empty') 
              ? parseFloat(document.getElementById('maint_raw').value) : 0;

  // --- 2. CWARåˆç®— ---
  // å¤–å‡º(out)ã¯AIãŒç®—å‡ºã—ãŸå€¤ã‚’ãã®ã¾ã¾ä½¿ã†
  const out_v = parseFloat(document.getElementById('out_raw')?.value || 0);

  const global_cwar = c_s + t_s + n_s + s_s + m_s + out_v;

  // é‡è¦–ã™ã‚‹æŒ‡æ¨™ã®ãƒœãƒ¼ãƒŠã‚¹
  const weightedKey = document.getElementById('weightedAxis').value;
  let bonus = 0;
  if (weightedKey === "cost_score") bonus = c_s;
  else if (weightedKey === "time_score") bonus = t_s;
  else if (weightedKey === "nutrition_score") bonus = n_s;
  else if (weightedKey === "satisfaction_score") bonus = s_s;
  else if (weightedKey === "maint_score") bonus = m_s;

  const local_cwar = global_cwar + bonus;

  // --- 3. åˆ¤å®šè¡¨ç¤ºã¨ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–° ---
  const isWin = local_cwar >= 0;
  const resultLabel = isWin ? "ã€å‹ã¡é£¯ã€‘" : "ã€è² ã‘é£¯ã€‘";
  const newScoreLine = `${resultLabel} CWAR ${local_cwar.toFixed(2)}`;

  if (iconEl) {
    iconEl.src = isWin ? IMG_WIN : IMG_LOSE;
    iconEl.style.display = 'block';
  }

  // ã‚³ãƒ¡ãƒ³ãƒˆæ›¸ãæ›ãˆ
  let lines = (commentEl.value || "").split('\n');
  if (lines[0] && (lines[0].includes("ã€å‹ã¡é£¯ã€‘") || lines[0].includes("ã€è² ã‘é£¯ã€‘") || lines[0].includes("CWAR"))) {
    lines[0] = newScoreLine;
  } else {
    (commentEl.value.trim() !== "") ? lines.unshift(newScoreLine) : lines[0] = newScoreLine;
  }
  commentEl.value = lines.join('\n');
}

// ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ä»¥å¤–ã®æ•°å€¤å…¥åŠ›é …ç›®ã‚‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã«åŠ ãˆã‚‹
document.addEventListener('DOMContentLoaded', () => {
  const targetIds = [
    'cost_raw', 
    'time_raw', 
    'nutrition_raw', 
    'weightedAxis', 
    'cooking_style', // â˜…ã“ã“ã‚’è¿½åŠ ï¼šé£Ÿäº‹ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç›£è¦–
    'meal_type'
  ];

  targetIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      // å…¥åŠ›(input)ã‚„é¸æŠ(change)ãŒã‚ã£ãŸã‚‰å³åº§ã«è¨ˆç®—ãƒ»ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
      el.addEventListener('input', updateCommentScore);
    }
  });
});
</script>
</body>
</html>
