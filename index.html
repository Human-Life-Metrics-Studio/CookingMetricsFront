<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cooking Metrics Studio</title>
  <style>
    body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f4f7f6; display: flex; justify-content: center; padding: 20px; }
    .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 100%; max-width: 500px; }
    .logo-container { text-align: center; margin-bottom: 25px; }
    .logo-container img { width: 100%; max-width: 350px; border-radius: 8px; }
    label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.85rem; color: #34495e; }
    input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
    #preview { width: 100%; max-height: 200px; object-fit: contain; margin-top: 10px; border-radius: 8px; display: none; border: 1px dashed #ccc; }
    .metric-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 10px; background: #fdfdfd; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
    .unit-label { font-size: 0.75rem; color: #95a5a6; margin-left: 4px; font-weight: normal; }
    .range-section { margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; }
    .range-container { margin-bottom: 15px; }
    .slider-wrapper { padding: 10px 0; display: flex; align-items: center; }
    input[type="range"] { width: 100%; cursor: pointer; height: 8px; accent-color: #3498db; }
    /* åˆæœŸçŠ¶æ…‹ã‚’è¦–è¦šçš„ã«è–„ãã™ã‚‹ */
    input[type="range"].initial-empty { opacity: 0.3; }
    .score-num { font-weight: bold; color: #3498db; margin-left: 10px; float: right; }
    .btn-group { margin-top: 25px; display: flex; flex-direction: column; gap: 12px; border-top: 2px dashed #eee; padding-top: 20px; }
    button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: transform 0.1s; }
    button:active { transform: scale(0.98); }
    #analyzeBtn { background-color: #3498db; color: white; }
    #loading { display: none; text-align: center; color: #3498db; margin: 10px 0; font-weight: bold; }
    .action-row { display: flex; gap: 12px; }
    .btn-save { flex: 3; background: linear-gradient(135deg, #2ecc71, #27ae60) !important; color: white; box-shadow: 0 4px 15px rgba(46,204,113,0.3); font-size: 1.1em !important; }
    .btn-clear { flex: 1; background: #f8f9fa !important; color: #636e72 !important; border: 1px solid #dfe6e9 !important; font-size: 0.9em !important; }

.description {
      font-size: 0.85rem;
      color: #7f8c8d;
      line-height: 1.5;
      margin: -10px 0 20px 0;
      text-align: center;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
    }
    .description em {
      font-style: normal;
      color: #3498db;
      font-weight: bold;
    }    
  </style>
</head>
<body>

<div class="container">
  <div class="logo-container">
    <img src="https://raw.githubusercontent.com/Human-Life-Metrics-Studio/CookingMetricsFront/main/images/frontHeader.png" alt="Cooking Metrics Studio">
  </div>
  
  <div class="description">
    ãƒ¡ãƒ‹ãƒ¥ãƒ¼åã‚„æ•°å€¤ã‚’è‡ªåˆ†ã§å…¥åŠ›ã—ã¦ã‚‚ã€<em>ã€ŒAIã§åˆ†æã€</em>ã«ãŠä»»ã›ã—ã¦ã‚‚OKã§ã™ã€‚<br>
    AIã®æ¨æ¸¬çµæœã¯å¾Œã‹ã‚‰è‡ªç”±ã«æ›¸ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚
  </div>

  <label>ğŸ“¸ æ–™ç†å†™çœŸ</label>
  <input type="file" id="photo" accept="image/*" onchange="previewImage(this)">
  <img id="preview">

  <label>ğŸ½ ãƒ¡ãƒ‹ãƒ¥ãƒ¼å</label>
  <input type="text" id="menu" placeholder="ä¾‹ï¼šè‚‰ã˜ã‚ƒãŒã€ã‚ªãƒ ãƒ©ã‚¤ã‚¹">

  <label>ğŸ•’ é£Ÿäº‹ã®åŒºåˆ†</label>
  <select id="meal_type">
    <option value="æœé£Ÿ">â˜€ï¸ æœé£Ÿ</option>
    <option value="æ˜¼é£Ÿ" selected>ğŸ•› æ˜¼é£Ÿ</option>
    <option value="å¤•é£Ÿ">ğŸŒ™ å¤•é£Ÿ</option>
  </select>

  <label>ğŸ¯ é‡è¦–ã™ã‚‹æŒ‡æ¨™</label>
  <select id="weightedAxis">
    <option value="satisfaction_score">ğŸ˜Š æº€è¶³åº¦ (é€šå¸¸)</option>
    <option value="cost_score">ğŸ’¸ è²»ç”¨ (ç¯€ç´„)</option>
    <option value="time_score">â± æ™‚é–“ (ã‚¿ã‚¤ãƒ‘)</option>
    <option value="nutrition_score">ğŸ¥— æ „é¤Š (å¥åº·)</option>
    <option value="maint_score">ğŸ”§ ä¿å®ˆæ€§ (æ¥½ã•)</option>
  </select>

  <div class="metric-grid">
    <div>
      <label>ğŸ’¸ è²»ç”¨ <span class="unit-label">(å††)</span></label>
      <input type="number" id="cost_raw" value="300">
    </div>
    <div>
      <label>â± æ™‚é–“ <span class="unit-label">(åˆ†)</span></label>
      <input type="number" id="time_raw" value="15">
    </div>
    <div style="grid-column: span 2;">
      <label>ğŸ¥— æ „é¤Š <span class="unit-label">(1-7ç¨®)</span></label>
      <input type="number" id="nutrition_raw" min="1" max="7" value="5">
    </div>
  </div>

  <div class="range-section">
    <div class="range-container">
      <label>ğŸ˜Š æº€è¶³åº¦: <span id="satisfaction_val" class="score-num">æœªå…¥åŠ›</span></label>
      <div class="slider-wrapper">
        <input type="range" id="satisfaction_raw" min="-0.3" max="0.3" step="0.05" class="initial-empty" oninput="updateVal('satisfaction')">
      </div>
    </div>

    <div class="range-container">
      <label>ğŸ”§ ä¿å®ˆæ€§è² è·: <span id="maint_val" class="score-num">æœªå…¥åŠ›</span></label>
      <div class="slider-wrapper">
        <input type="range" id="maint_raw" min="-0.4" max="0.3" step="0.05" class="initial-empty" oninput="updateVal('maint')">
      </div>
    </div>

    <label>ğŸ¥• ä¸»ãªé£Ÿæ</label>
    <input type="text" id="ingredients">

    <label>ğŸ“ ãƒ¡ãƒ¢</label>
    <textarea id="comment" rows="2"></textarea>
  </div>

  <div class="btn-group">
    <button id="analyzeBtn" onclick="runAnalysis()">1. AIã§åˆ†æ</button>
    <div id="loading">ğŸ“Š AIãŒè¨ˆç®—ä¸­...</div>
    
    <div class="action-row">
      <button id="saveBtn" onclick="runSave()" class="btn-save">2. ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
      <button type="button" onclick="clearForm()" class="btn-clear">ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <div id="successArea" style="display:none; margin-top:15px; padding:10px; border:2px solid #2ecc71; border-radius:8px; background:#fafffd; text-align:center;">
    <span style="color:#27ae60; font-weight:bold; display:block; margin-bottom:8px;">âœ… ä¿å­˜ã—ã¾ã—ãŸï¼</span>
    <a id="dashboardLink" href="#" target="_blank" style="color:#3498db; font-weight:bold; font-size:1.1rem;">
      ğŸ“Š ã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã™ã‚‹
    </a>
  </div>
</div>

<script>
  function previewImage(input) {
    const preview = document.getElementById('preview');
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = e => { preview.src = e.target.result; preview.style.display = 'block'; };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function roundToStep(value, step) {
    if (value === undefined || value === null) return "";
    return (Math.round(value / step) * step).toFixed(2);
  }

  function updateVal(type) {
    const el = document.getElementById(type + '_raw');
    const display = document.getElementById(type + '_val');
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‹•ã‹ã—ãŸã‚‰ã‚¯ãƒ©ã‚¹ã‚’æ¶ˆã™
    el.classList.remove('initial-empty');
    display.innerText = parseFloat(el.value).toFixed(2);
  }

  function clearForm() {
    if (!confirm("å…¥åŠ›ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) return;
    ['menu', 'photo', 'cost_raw', 'time_raw', 'nutrition_raw', 'ingredients', 'comment'].forEach(id => {
      document.getElementById(id).value = "";
    });
    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¯ç‰¹æ®Šãƒªã‚»ãƒƒãƒˆ
    ['satisfaction', 'maint'].forEach(type => {
      const el = document.getElementById(type + '_raw');
      el.classList.add('initial-empty');
      document.getElementById(type + '_val').innerText = "æœªå…¥åŠ›";
    });
    document.getElementById('preview').style.display = 'none';
    document.getElementById('successArea').style.display = 'none';
  }

  function runAnalysis() {
    const menu = document.getElementById('menu').value;
    const fileInput = document.getElementById('photo');
    const loading = document.getElementById('loading');
    const btn = document.getElementById('analyzeBtn');
    loading.style.display = 'block';
    btn.disabled = true;

    if (fileInput.files.length > 0) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const base64Data = e.target.result.split(',')[1];
        google.script.run
          .withSuccessHandler(res => { fillFields(res); btn.disabled = false; })
          .analyzeCookingWithImage(base64Data, menu);
      };
      reader.readAsDataURL(fileInput.files[0]);
    } else {
      if (!menu) { alert('å†™çœŸã‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼åãŒå¿…è¦ã§ã™'); loading.style.display = 'none'; btn.disabled = false; return; }
      google.script.run
        .withSuccessHandler(res => { fillFields(res); btn.disabled = false; })
        .analyzeCooking({ menu: menu });
    }
  }

  function fillFields(res) {
    document.getElementById('loading').style.display = 'none';
    const menuEl = document.getElementById('menu');
    if (!menuEl.value && res.menu) menuEl.value = res.menu;

    // æ•°å€¤å…¥åŠ›
    const sets = [
      { id: 'cost_raw', val: res.cost_val, def: "300" },
      { id: 'time_raw', val: res.time_val, def: "15" },
      { id: 'nutrition_raw', val: res.nutrition_val, def: "5" }
    ];
    sets.forEach(s => {
      const el = document.getElementById(s.id);
      if ((el.value === "" || el.value === s.def) && s.val !== undefined) el.value = s.val;
    });

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®åˆ¤å®šï¼šã‚¯ãƒ©ã‚¹ã€Œinitial-emptyã€ãŒä»˜ã„ã¦ã„ã‚‹ï¼ˆã¾ã æœªå…¥åŠ›ï¼‰ãªã‚‰AIçµæœã‚’æµã—è¾¼ã‚€
    const satEl = document.getElementById('satisfaction_raw');
    if (satEl.classList.contains('initial-empty') && res.satisfaction_score !== undefined) {
      satEl.value = roundToStep(res.satisfaction_score, 0.05);
      updateVal('satisfaction');
    }
    const maintEl = document.getElementById('maint_raw');
    if (maintEl.classList.contains('initial-empty') && res.maint_score !== undefined) {
      maintEl.value = roundToStep(res.maint_score, 0.05);
      updateVal('maint');
    }

    if (!document.getElementById('ingredients').value && res.ingredients) document.getElementById('ingredients').value = res.ingredients;
    if (!document.getElementById('comment').value && res.comment) document.getElementById('comment').value = res.comment;
  }

function runSave() {
    const saveBtn = document.getElementById('saveBtn');
    const menuName = document.getElementById('menu').value;
    if (!menuName) { alert('ãƒ¡ãƒ‹ãƒ¥ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

    saveBtn.disabled = true;
    saveBtn.innerText = "ä¿å­˜ä¸­...";

    // 1. å„ã‚¹ã‚³ã‚¢ã®ç®—å‡ºï¼ˆå…ƒã®è¨ˆç®—å¼ã®ã¾ã¾ï¼‰
    const c_s = Math.max(-0.5, 0.3 - (parseFloat(document.getElementById('cost_raw').value || 0) / 100 * 0.05));
    const t_s = Math.max(-0.5, 0.3 - (parseFloat(document.getElementById('time_raw').value || 0) * 0.02));
    
    const n_v = parseFloat(document.getElementById('nutrition_raw').value || 0);
    const n_s = n_v >= 7 ? 0.3 : n_v >= 6 ? 0.15 : n_v >= 5 ? 0.0 : n_v >= 4 ? -0.2 : -0.4;
    
    const satEl = document.getElementById('satisfaction_raw');
    const maintEl = document.getElementById('maint_raw');
    const s_s = satEl.classList.contains('initial-empty') ? 0 : parseFloat(satEl.value);
    const m_s = maintEl.classList.contains('initial-empty') ? 0 : parseFloat(maintEl.value);

    // 2. ã‚°ãƒ­ãƒ¼ãƒãƒ«CWAR
    const global_cwar = c_s + t_s + n_s + s_s + m_s;

    // --- ã€èª¿æŸ»ãƒ­ã‚°ï¼šã“ã“ã ã‘è¿½åŠ ã€‘ ---
    console.group("CWARä¸ä¸€è‡´ã®èª¿æŸ»");
    console.log("â‘ ã‚³ã‚¹ãƒˆ(c_s):", c_s);
    console.log("â‘¡æ™‚é–“(t_s):", t_s);
    console.log("â‘¢æ „é¤Š(n_s):", n_s);
    console.log("â‘£æº€è¶³(s_s):", s_s);
    console.log("â‘¤ä¿å®ˆ(m_s):", m_s);
    console.log("---");
    console.log("è¨ˆç®—ä¸Šã®åˆè¨ˆ:", global_cwar);
    console.groupEnd();
    // ---------------------------------

    const weightedKey = document.getElementById('weightedAxis').value;
    let bonus = 0;
    if (weightedKey === "cost_score") bonus = c_s;
    else if (weightedKey === "time_score") bonus = t_s;
    else if (weightedKey === "nutrition_score") bonus = n_s;
    else if (weightedKey === "satisfaction_score") bonus = s_s;
    else if (weightedKey === "maint_score") bonus = m_s;

    const local_cwar = global_cwar + bonus;

    const finalData = {
      menu: menuName,
      meal_type: document.getElementById('meal_type').value,
      ingredients: document.getElementById('ingredients').value,
      cost_raw: parseFloat(document.getElementById('cost_raw').value || 0),
      time_raw: parseFloat(document.getElementById('time_raw').value || 0),
      cost_score: c_s,
      time_score: t_s,
      nutrition_score: n_s,
      satisfaction_score: s_s,
      maint_score: m_s,
      global_cwar: global_cwar,
      local_cwar: local_cwar,
      weightedAxisKey: weightedKey, 
      weightedAxisLabel: document.getElementById('weightedAxis').options[document.getElementById('weightedAxis').selectedIndex].text,
      comment: document.getElementById('comment').value
    };

    google.script.run
      .withSuccessHandler(url => {
        saveBtn.disabled = false;
        saveBtn.innerText = "2. ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜";
        document.getElementById('dashboardLink').href = url;
        document.getElementById('successArea').style.display = 'block';
        document.getElementById('successArea').scrollIntoView({ behavior: 'smooth' });
      })
      .saveDataAndGetDashboardUrl(finalData);
}
</script>
</body>
</html>